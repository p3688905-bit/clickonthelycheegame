<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>嶺南荔枝樂 - 日啖三百顆</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Q-Style elements and responsiveness */
        body { font-family: 'Inter', sans-serif; background-color: #fef3c7; /* Light creamy yellow background */ }
        .game-container {
            min-height: 85vh; /* Ensure it takes up most of the mobile screen height */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .fruit-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s ease-out, opacity 0.1s ease-out;
            border: 4px solid #fff; /* White border for emphasis */
        }
        .fruit-icon:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        .correct-click {
            background-color: #6ee7b7; /* Emerald 300 for feedback */
            animation: pop 0.2s ease-out;
        }
        .wrong-click {
            background-color: #f87171; /* Red 400 for feedback */
            animation: shake 0.5s;
        }
        /* Fever Mode visual effect */
        .fever-mode {
            background-color: #fffbeb; /* Light gold background */
            transition: background-color 0.5s;
        }

        /* Keyframe animations for Q-Style feedback */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse {
            animation: pulse 1s infinite;
        }
        .clarification-list {
            list-style-type: none;
            padding-left: 0;
        }
        .clarification-list li::before {
            content: '👉';
            margin-right: 8px;
            font-size: 0.9em;
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center justify-center min-h-screen transition-colors duration-500">

    <div class="w-full max-w-md bg-white rounded-3xl p-4 shadow-2xl game-container flex flex-col">

        <!-- Header and Status Bar -->
        <header class="text-center mb-4">
            <h1 class="text-3xl font-extrabold text-pink-600 mb-1">
                嶺南荔枝樂
            </h1>
            <p id="poem-text" class="text-sm italic text-gray-500 transition-colors duration-500">羅浮山下四時春</p>
        </header>

        <div class="flex justify-between items-center p-2 bg-pink-100 rounded-xl shadow-inner mb-4">
            <div class="text-center flex-1">
                <p class="text-xs text-pink-700 font-semibold">荔枝 (顆)</p>
                <p id="litchi-count" class="text-3xl font-black text-pink-800">0</p>
            </div>
            <div class="text-center flex-1">
                <p class="text-xs text-gray-700 font-semibold">連擊 (Combo)</p>
                <p id="combo-count" class="text-3xl font-black text-orange-600">0</p>
            </div>
            <div class="text-center flex-1">
                <p class="text-xs text-gray-700 font-semibold">精力值</p>
                <div class="relative pt-1">
                    <div class="overflow-hidden h-3 mb-4 text-xs flex rounded-lg bg-green-200">
                        <div id="health-bar" style="width:100%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-green-500 rounded-lg transition-all duration-300"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Info / Messages -->
        <div id="game-message" class="text-center h-8 mb-4 text-xl font-bold text-gray-600">
            請先閱讀圖標說明，然後點擊「開始」！
        </div>

        <!-- Game Area - Where fruits appear or instructions are shown -->
        <div id="game-area" class="flex-grow bg-white rounded-2xl p-4 border-4 border-dashed border-pink-200 flex flex-wrap justify-center items-center content-center gap-4 transition-colors duration-500">
            <!-- Instructions and Difficulty Form will be populated here by JavaScript on load -->
        </div>

        <!-- Control Buttons -->
        <div class="mt-6 flex justify-center">
            <button id="start-button" class="px-8 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-full text-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                開始「嶺南日」
            </button>
            <button id="restart-button" class="hidden px-8 py-3 bg-red-500 hover:bg-red-600 text-white font-bold rounded-full text-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                重新開始
            </button>
        </div>

    </div>

    <script>
        // Global Constants
        const LITCHI = '荔枝';
        const LOQUAT = '盧橘';
        const WAX_APPLE = '楊梅';
        const FEVER_FRUIT = '仙果'; 
        const FRUIT_SEQUENCE = [LITCHI, LOQUAT, WAX_APPLE];
        const MAX_HEALTH = 100;
        const GAME_DURATION_MS = 60000; 
        const FEVER_DURATION_MS = 5000; 
        const ULTIMATE_GOAL_DAYS = 5; // 設置終極目標天數：成功挑戰 5 天

        // Difficulty Presets
        const DIFFICULTY_PRESETS = {
            leisurely: {
                label: "悠閒 (入門)",
                dailyGoal: 200,
                feverChance: 0.25, // 25% chance
                wrongClickCost: 3,
                description: "荔枝目標較低，仙果出現機率高。適合輕鬆體驗。",
                color: "text-green-600"
            },
            su_shi: {
                label: "蘇軾 (標準)",
                dailyGoal: 300,
                feverChance: 0.15, // 15% chance
                wrongClickCost: 5,
                description: "日啖三百顆。挑戰均衡難度，最貼近原詩意境。",
                color: "text-amber-600"
            },
            challenge: {
                label: "挑戰 (考驗)",
                dailyGoal: 450,
                feverChance: 0.05, // 5% chance
                wrongClickCost: 10,
                description: "目標極高，仙果稀少，誤點懲罰嚴厲。",
                color: "text-red-600"
            }
        };


        // Seasonal Colors for "四時春" (Spring all four seasons)
        const SEASON_COLORS = [
            'border-emerald-400', // Early Spring Green
            'border-pink-400',    // Blossom Spring Pink
            'border-sky-400',     // Clear Spring Sky
            'border-amber-400'    // Late Spring Harvest Gold
        ];
        const SEASON_TEXTS = [
            '羅浮山下四時春 (早春)', 
            '羅浮山下四時春 (花開)', 
            '羅浮山下四時春 (晴日)', 
            '羅浮山下四時春 (豐收)'
        ];

        // DOM Elements
        const litchiCountEl = document.getElementById('litchi-count');
        const comboCountEl = document.getElementById('combo-count');
        const healthBarEl = document.getElementById('health-bar');
        const gameAreaEl = document.getElementById('game-area');
        const startButton = document.getElementById('start-button');
        const restartButton = document.getElementById('restart-button');
        const gameMessageEl = document.getElementById('game-message');
        const poemTextEl = document.getElementById('poem-text');
        const bodyEl = document.body;

        // Game State
        let gameState = {
            isRunning: false,
            litchi: 0,
            combo: 0,
            health: MAX_HEALTH,
            targetFruit: null,
            timer: null,
            day: 0,
            targetIndex: 0,
            isFever: false,
            feverTimer: null,
            // Dynamic Settings based on difficulty
            dailyGoal: DIFFICULTY_PRESETS.su_shi.dailyGoal,
            feverChance: DIFFICULTY_PRESETS.su_shi.feverChance,
            wrongClickCost: DIFFICULTY_PRESETS.su_shi.wrongClickCost,
        };

        // --- Utility Functions ---

        /** Updates the dynamic settings based on the selected difficulty key. */
        function applyDifficultySetting(difficultyKey) {
            const settings = DIFFICULTY_PRESETS[difficultyKey] || DIFFICULTY_PRESETS.su_shi;
            gameState.dailyGoal = settings.dailyGoal;
            gameState.feverChance = settings.feverChance;
            gameState.wrongClickCost = settings.wrongClickCost;
            
            // Update the start button text to reflect the goal
            startButton.textContent = `開始 (目標: ${gameState.dailyGoal} 顆)`;
        }

        /** Updates the seasonal theme based on the current day. */
        function updateSeasonalTheme() {
            if (gameState.day === 0) return;
            
            const seasonIndex = (gameState.day - 1) % SEASON_COLORS.length;
            const colorClass = SEASON_COLORS[seasonIndex];
            const seasonText = SEASON_TEXTS[seasonIndex];

            SEASON_COLORS.forEach(cls => gameAreaEl.classList.remove(cls, cls.replace('border', 'text')));
            
            gameAreaEl.classList.add('border-4', 'border-dashed', colorClass);

            poemTextEl.textContent = seasonText;
            
            SEASON_COLORS.forEach(cls => poemTextEl.classList.remove(cls.replace('border', 'text')));
            poemTextEl.classList.add(colorClass.replace('border', 'text'));
        }

        /** Updates all display elements based on the current gameState. */
        function updateUI() {
            litchiCountEl.textContent = gameState.litchi;
            comboCountEl.textContent = gameState.combo;
            healthBarEl.style.width = `${gameState.health}%`;
            healthBarEl.className = `shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center rounded-lg transition-all duration-300 ${gameState.health > 50 ? 'bg-green-500' : gameState.health > 20 ? 'bg-yellow-500' : 'bg-red-500'}`;
            
            if (gameState.isFever) {
                bodyEl.classList.add('fever-mode');
                gameMessageEl.classList.add('text-yellow-600', 'animate-pulse');
            } else {
                bodyEl.classList.remove('fever-mode');
                gameMessageEl.classList.remove('text-yellow-600', 'animate-pulse');
            }
        }

        /** Chooses the next fruit to be the target in the sequence. */
        function getNextTargetFruit() {
            const fruit = FRUIT_SEQUENCE[gameState.targetIndex % FRUIT_SEQUENCE.length];
            gameState.targetIndex++;
            return fruit;
        }

        /** Maps fruit name to Q-style emoji and color for display. */
        function getFruitData(fruitName) {
            switch (fruitName) {
                case LITCHI:
                    return { emoji: '🍒', color: 'bg-pink-500 hover:bg-pink-600' };
                case LOQUAT:
                    return { emoji: '🍑', color: 'bg-amber-400 hover:bg-amber-500' };
                case WAX_APPLE:
                    return { emoji: '🫐', color: 'bg-indigo-600 hover:bg-indigo-700' };
                case FEVER_FRUIT: 
                    return { emoji: '✨', color: 'bg-yellow-400 ring-4 ring-yellow-300 animate-pulse' };
                default:
                    return { emoji: '❓', color: 'bg-gray-500' };
            }
        }

        /** Creates a clickable fruit button element. */
        function createFruitButton(fruitName) {
            const data = getFruitData(fruitName);
            const button = document.createElement('button');
            button.className = `fruit-icon w-20 h-20 sm:w-24 sm:h-24 rounded-full text-5xl font-extrabold shadow-lg ${data.color}`;
            button.dataset.fruit = fruitName;
            button.innerHTML = data.emoji;
            return button;
        }

        /** Spawns the required target fruit and some distractors. */
        function spawnFruits() {
            gameAreaEl.innerHTML = ''; 
            
            if (!gameState.isFever) {
                gameState.targetFruit = getNextTargetFruit();
                gameMessageEl.textContent = `快點擊 ${gameState.targetFruit}！`;
            } else {
                gameMessageEl.textContent = '🔥🔥 狂熱仙果模式! 狂吃三百顆! 🔥🔥';
                gameState.targetFruit = null;
            }


            const allFruitsToSpawn = [];
            const distractors = FRUIT_SEQUENCE.filter(f => f !== gameState.targetFruit);

            // 1. Add Fever Fruit (Uses dynamic chance)
            if (Math.random() < gameState.feverChance && !gameState.isFever) {
                allFruitsToSpawn.push(FEVER_FRUIT);
            }
            
            // 2. Add Target Fruit (if not in fever mode)
            if (!gameState.isFever) {
                allFruitsToSpawn.push(gameState.targetFruit);
            }

            // 3. Fill the rest with a mix of all three main fruits
            const totalSlots = 5; 
            while (allFruitsToSpawn.length < totalSlots) {
                const randomFruit = FRUIT_SEQUENCE[Math.floor(Math.random() * FRUIT_SEQUENCE.length)];
                allFruitsToSpawn.push(randomFruit);
            }

            allFruitsToSpawn.sort(() => Math.random() - 0.5);

            allFruitsToSpawn.forEach(fruitName => {
                const button = createFruitButton(fruitName);
                gameAreaEl.appendChild(button);
            });
        }
        
        /** Activates the Fever Mode for a short duration. */
        function activateFeverMode() {
            if (gameState.feverTimer) clearTimeout(gameState.feverTimer);
            
            gameState.isFever = true;
            gameState.targetIndex--; 
            
            gameState.feverTimer = setTimeout(deactivateFeverMode, FEVER_DURATION_MS);
            
            updateUI();
            spawnFruits(); 
        }

        /** Deactivates the Fever Mode. */
        function deactivateFeverMode() {
            gameState.isFever = false;
            gameState.feverTimer = null;
            
            gameMessageEl.textContent = '狂熱結束，請恢復順序點擊。';
            
            updateUI();
            spawnFruits(); 
        }

        /** Handles fruit click event. */
        function handleFruitClick(event) {
            if (!gameState.isRunning) return;

            const clickedFruit = event.target.closest('.fruit-icon');
            if (!clickedFruit) return;

            const fruitName = clickedFruit.dataset.fruit;

            const applyFeedback = (className) => {
                clickedFruit.classList.add(className);
                setTimeout(() => clickedFruit.classList.remove(className), 300);
            };

            // 1. Check for FEVER FRUIT click
            if (fruitName === FEVER_FRUIT) {
                applyFeedback('correct-click');
                clickedFruit.style.visibility = 'hidden'; 
                if (!gameState.isFever) {
                    activateFeverMode();
                }
                return;
            }

            if (gameState.isFever) {
                // 2. FEVER MODE LOGIC
                applyFeedback('correct-click');
                
                gameState.combo = Math.min(99, gameState.combo + 2); 
                let litchiReward = 5; 
                gameState.litchi += litchiReward;
                
                gameState.health = Math.min(MAX_HEALTH, gameState.health + 1);

            } else if (fruitName === gameState.targetFruit) {
                // 3. NORMAL CORRECT CLICK
                applyFeedback('correct-click');
                gameState.combo++;
                
                let litchiReward = 1;
                if (gameState.combo > 5) litchiReward = 2;
                if (gameState.combo > 10) litchiReward = 3;

                if (fruitName === LITCHI) {
                    gameState.litchi += litchiReward;
                }
                
                if (gameState.combo % 5 === 0 && gameState.combo > 0) {
                     gameState.health = Math.min(MAX_HEALTH, gameState.health + 2);
                }

                spawnFruits(); 

            } else {
                // 4. WRONG CLICK (Uses dynamic cost)
                applyFeedback('wrong-click');
                gameState.combo = 0;
                gameState.health = Math.max(0, gameState.health - gameState.wrongClickCost); // Use dynamic cost
                gameMessageEl.textContent = `❌ 連擊中斷! (精力 -${gameState.wrongClickCost})`;
                
                if (gameState.health === 0) {
                    endGame('精力耗盡');
                }
            }

            updateUI();
        }

        /** Starts the main game loop. */
        function startGame() {
            // Apply the currently selected difficulty settings just in case
            const selectedDifficulty = document.querySelector('input[name="difficulty"]:checked');
            if(selectedDifficulty) {
                applyDifficultySetting(selectedDifficulty.value);
            }
            
            gameState.litchi = 0;
            gameState.combo = 0;
            gameState.health = MAX_HEALTH;
            gameState.isRunning = true;
            gameState.day++;
            gameState.targetIndex = 0;
            gameState.isFever = false;
            clearTimeout(gameState.feverTimer);

            startButton.classList.add('hidden');
            restartButton.classList.add('hidden');
            gameAreaEl.addEventListener('click', handleFruitClick);

            gameMessageEl.textContent = `第 ${gameState.day} 個嶺南日開始！目標: ${gameState.dailyGoal} 顆`;

            updateSeasonalTheme();
            spawnFruits();
            updateUI();

            gameState.timer = setTimeout(() => {
                checkDailyGoal();
            }, GAME_DURATION_MS);
        }

        /** Checks the daily goal and proceeds or ends the game. */
        function checkDailyGoal() {
            if (!gameState.isRunning) return;

            gameAreaEl.removeEventListener('click', handleFruitClick);
            clearTimeout(gameState.timer);
            clearTimeout(gameState.feverTimer);
            gameState.isRunning = false;
            gameState.isFever = false;

            if (gameState.litchi >= gameState.dailyGoal) {
                
                if (gameState.day >= ULTIMATE_GOAL_DAYS) {
                    // 達成終極目標
                    gameMessageEl.textContent = `🏆 恭喜您！達成「長作嶺南人」的目標！`;
                    endGame('成功達成目標'); 
                    return;
                }
                
                gameMessageEl.textContent = `🎉 太棒了！今天吃足 ${gameState.litchi} 顆荔枝！`;
                
                startButton.textContent = `繼續挑戰第 ${gameState.day + 1} 日`;
                startButton.classList.remove('hidden');
            } else {
                endGame(`未能達成每日 ${gameState.dailyGoal} 顆荔枝的目標。`);
            }
        }

        /** Ends the game and displays final results. */
        function endGame(reason) {
            clearTimeout(gameState.timer);
            clearTimeout(gameState.feverTimer);
            gameState.isRunning = false;
            gameState.isFever = false;
            gameAreaEl.removeEventListener('click', handleFruitClick);
            
            let finalMessage = '';
            
            if (reason === '成功達成目標') {
                finalMessage = `
                    <p class="text-3xl font-black text-yellow-600 mb-2">🎉 最終勝利！</p>
                    <p class="text-xl text-yellow-800 mb-4">🏆 不辭長作嶺南人 🏆</p>
                    <p class="text-lg">您已成功挑戰 <span class="text-2xl font-extrabold text-pink-600">${gameState.day}</span> 個嶺南日！</p>
                    <p class="text-lg">總荔枝數: <span class="text-2xl font-extrabold text-pink-600">${gameState.litchi}</span> 顆</p>
                    <p class="text-sm mt-4 text-gray-500">（在下次挑戰中，目標將重新設定）</p>
                `;
            } else {
                finalMessage = `
                    <p class="text-3xl font-black text-red-600 mb-2">遊戲結束!</p>
                    <p class="text-xl text-gray-700 mb-4">${reason}</p>
                    <p class="text-lg">總共在嶺南停留了 <span class="text-2xl font-extrabold text-pink-600">${gameState.day}</span> 天。</p>
                    <p class="text-lg">總荔枝數: <span class="text-2xl font-extrabold text-pink-600">${gameState.litchi}</span> 顆</p>
                `;
            }
            
            gameAreaEl.innerHTML = `<div class="text-center p-6 w-full">${finalMessage}</div>`;

            startButton.classList.add('hidden');
            restartButton.classList.remove('hidden');
        }

        /** Displays the fruit icon clarification and difficulty form. */
        function showClarification() {
            let formHTML = `
                <div id="clarification-info" class="text-left p-4 bg-gray-50 rounded-xl shadow-md w-full max-w-xs mx-auto space-y-4">
                    
                    <!-- 遊戲獲勝與獎賞區塊 -->
                    <h3 class="text-xl font-bold text-gray-800 border-b pb-2">遊戲獲勝與獎賞</h3>
                    <ul class="clarification-list text-sm text-gray-700 space-y-2">
                        <li class="font-semibold text-gray-700">🏆 <strong class="text-green-600">每日勝利</strong>：在 60 秒內達成荔枝目標，即可進入下一日挑戰。邊框會隨著「四時春」更換季節主題。</li>
                        <li class="font-semibold text-gray-700">🥇 <strong class="text-yellow-600">終極成就</strong>：成功挑戰連續 <span class="text-lg font-extrabold text-pink-600">${ULTIMATE_GOAL_DAYS}</span> 個嶺南日後，您將獲得「不辭長作嶺南人」的稱號！</li>
                        <li class="font-semibold text-gray-700">💔 <strong class="text-red-600">失敗條件</strong>：精力值耗盡，或 60 秒內未達成每日目標。</li>
                    </ul>
                    
                    <!-- 設計源頭與概念區塊 -->
                    <h3 class="text-xl font-bold text-gray-800 border-b pb-2 pt-2">設計源頭與概念</h3>
                    <p class="text-sm text-gray-700 leading-relaxed mb-4">
                        本遊戲靈感來自蘇軾的《惠州一絕》：<br>
                        「羅浮山下<strong class="text-emerald-600">四時春</strong>，盧橘楊梅<strong class="text-pink-600">次第新</strong>。<br>
                        <strong class="text-pink-800">日啖荔枝三百顆</strong>，不辭長作嶺南人。」
                    </p>
                    <ul class="clarification-list text-sm text-gray-700 space-y-1">
                        <li class="font-semibold text-gray-700">📌 <strong class="text-emerald-600">「四時春」</strong>：邊框顏色隨挑戰日變化，象徵四季生機。</li>
                        <li class="font-semibold text-gray-700">📌 <strong class="text-pink-600">「次第新」</strong>：玩家須按固定順序點擊水果，體現豐收的節奏。</li>
                        <li class="font-semibold text-gray-700">📌 <strong class="text-pink-800">「三百顆」</strong>：是每日目標，鼓勵玩家快速累積荔枝。</li>
                    </ul>

                    <h3 class="text-xl font-bold text-gray-800 border-b pb-2 pt-2">水果圖標說明 (Q版)</h3>
                    <p class="text-sm mb-1 text-gray-600 font-bold">請依序點擊 (次第新): 荔枝 → 盧橘 → 楊梅</p>
                    <ul class="clarification-list text-base text-gray-700 space-y-2 mb-4">
                        <li class="font-semibold">🍒 <span class="text-pink-600">荔枝 (Litchi)</span></li>
                        <li class="font-semibold">🍑 <span class="text-amber-600">盧橘 (枇杷)</span></li>
                        <li class="font-semibold">🫐 <span class="text-indigo-600">楊梅 (Wax Apple)</span></li>
                        <li class="font-semibold">✨ <span class="text-yellow-600">狂熱仙果</span>: 點擊後進入高分模式！</li>
                    </ul>

                    <h3 class="text-xl font-bold text-gray-800 border-b pb-2">遊戲提案與難度選擇</h3>
                    <form id="difficulty-form" class="space-y-3">
            `;

            // Dynamically create radio buttons for difficulty presets
            for (const key in DIFFICULTY_PRESETS) {
                const preset = DIFFICULTY_PRESETS[key];
                const checked = key === 'su_shi' ? 'checked' : '';
                
                formHTML += `
                    <label class="flex items-start p-2 rounded-lg cursor-pointer hover:bg-gray-100 border border-gray-200">
                        <input type="radio" name="difficulty" value="${key}" ${checked} class="mt-1 form-radio text-pink-500 border-gray-300 focus:ring-pink-500">
                        <div class="ml-3">
                            <span class="font-bold text-lg ${preset.color}">${preset.label}</span>
                            <p class="text-xs text-gray-500 mt-0.5">目標: ${preset.dailyGoal} 顆 | 仙果: ${(preset.feverChance * 100)}% | 誤點: -${preset.wrongClickCost} 精力</p>
                            <p class="text-xs text-gray-700 mt-1">${preset.description}</p>
                        </div>
                    </label>
                `;
            }

            formHTML += `</form></div>`;
            
            gameAreaEl.innerHTML = formHTML;

            // Add event listeners to radio buttons to update the state immediately
            document.getElementById('difficulty-form').addEventListener('change', (e) => {
                if (e.target.name === 'difficulty') {
                    applyDifficultySetting(e.target.value);
                }
            });

            // Set initial difficulty for the start button text
            applyDifficultySetting('su_shi'); 

            gameAreaEl.removeEventListener('click', handleFruitClick);
            startButton.classList.remove('hidden');
            restartButton.classList.add('hidden');
        }

        // --- Event Listeners and Initialization ---

        startButton.addEventListener('click', startGame);
        restartButton.addEventListener('click', () => {
            gameState.day = 0; 
            showClarification();
            gameMessageEl.textContent = '請先選擇難度，然後開始「嶺南日」！';
            updateUI();
        });

        // Initial setup
        showClarification();
        updateUI();

    </script>
</body>
</html>
